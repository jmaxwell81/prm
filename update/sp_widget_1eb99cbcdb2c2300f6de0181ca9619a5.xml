<?xml version="1.0" encoding="UTF-8"?>
<record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <client_script><![CDATA[function($scope,spUtil,$location) {
  /* widget controller */
  var c = this;
	
	c.catSelect = function(item) {
		//alert(item);
		var url = "?id=kb_category&kb_category=" + item;	
		$location.url(url).replace();
	}
	
	c.hasChildren = function(cat) {
		return (c.data.categories.hasOwnProperty(cat.sys_id));
	}

}]]></client_script>
        <controller_as>c</controller_as>
        <css>//For some reason the mouse cursor needs help to change into a pointing finger&#13;
[ng-click],&#13;
[data-ng-click],&#13;
[x-ng-click] {&#13;
    cursor: pointer;&#13;
}&#13;
&#13;
a.category {&#13;
  color: #717171;&#13;
}&#13;
&#13;
.right {&#13;
  //position: absolute;&#13;
  //right: 0px;&#13;
  display:inline;&#13;
  float:right;&#13;
}&#13;
&#13;
.middle {&#13;
  padding-top: 6px;&#13;
}&#13;
&#13;
.list-group-item:hover {&#13;
  &#13;
  background-color:  rgba(153, 204, 255, 0.9);&#13;
}&#13;
.list-group {&#13;
  margin: 0px;&#13;
}&#13;
&#13;
.darken {&#13;
  background-color:  rgba(153, 204, 255, 0.5);&#13;
}&#13;
&#13;
.panel-heading {&#13;
  color:#D5DDE5;;&#13;
  background:#428bca;&#13;
  border-bottom:4px solid #80bfff;&#13;
  border-right: 1px solid #343a45;&#13;
  font-size:20px;&#13;
  padding:15px;&#13;
  text-align:left;&#13;
  text-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);&#13;
  vertical-align:middle;&#13;
}&#13;
&#13;
.list-group-item {&#13;
  background: transparent;&#13;
  padding-left: 5px;&#13;
}&#13;
&#13;
.cat-icon {&#13;
  height: 25px;&#13;
  width:25px;&#13;
  background-size: contain;&#13;
  background-repeat: no-repeat;&#13;
  background-position: center center;&#13;
  position: absolute;&#13;
  left: 10px;&#13;
  top:7px;&#13;
}&#13;
&#13;
.active {&#13;
  font-weight: bold;&#13;
}&#13;
&#13;
&#13;
// 2nd Level Indent&#13;
.list-group &gt; .list-group {&#13;
  .list-group-item {&#13;
    padding-left: 25px;&#13;
  }&#13;
  .cat-icon {&#13;
    left: 0px;&#13;
  }&#13;
}&#13;
&#13;
// 3rd Level Indent&#13;
.list-group &gt; .list-group &gt; .list-group {&#13;
  .list-group-item {&#13;
    padding-left: 50px;&#13;
    border-bottom: 1px solid rgba(255, 255, 255, 1);&#13;
  }&#13;
  .cat-icon {&#13;
    left: 00px;&#13;
  }&#13;
}&#13;
&#13;
// 4th Level Indent&#13;
.list-group &gt; .list-group &gt; .list-group &gt; .list-group {&#13;
  .list-group-item {&#13;
    padding-left: 75px;&#13;
  }&#13;
  .cat-icon {&#13;
    left: 0px;&#13;
  }&#13;
}</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>true</has_preview>
        <id/>
        <internal>false</internal>
        <link/>
        <name>PRM E-Learning Categories Multi Level</name>
        <option_schema>[{"displayValue":"Knowledge Base","hint":"Use a specific knowledge base instead of the portal default","name":"knowledge_base","label":"Knowledge Base","type":"reference","value":"kb_knowledge_base","ed":{"reference":"kb_knowledge_base"}}]</option_schema>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
	data.category_id = $sp.getParameter("kb_category");
			
	data.categories = {};
	data.kb = options.knowledge_base ? options.knowledge_base : $sp.getValue("kb_knowledge_base");
	
	if (!data.kb)
		data.kb = "a7e8a78bff0221009b20ffffffffff17"; //For preview purposes
	
	var kc = new GlideRecord('kb_category');
	kc.addActiveQuery();
	kc.orderBy('label');
	kc.query();

	while (kc.next()) {
		//Dont show category if empty
		if ($sp.getKBCategoryArticles(kc.getUniqueValue()) == 0)
			continue;
		
		var cat = {};
		cat.title = kc.label.getDisplayValue();
		cat.open = isSubCat(kc.sys_id,data.category_id) || data.category_id == kc.sys_id;
		cat.sys_id = kc.getUniqueValue();

		//Check if category has parent or is top category
		if (kc.parent_table == 'kb_category')
			cat.parent = kc.getValue('parent_id');
		else if (kc.parent_id == data.kb)
			cat.parent = "top";

		if (!data.categories[cat.parent])
			data.categories[cat.parent] = [];

		data.categories[cat.parent].push(cat);			
	}
	
	function isSubCat(cat,subcat) { //Check if a category is a subcategory to another
			if (!subcat)
				return false;
		
			var kc = new GlideRecord('kb_category');

			//Get our subcategory
			if (kc.get(subcat)) {
				//See if the main category is one of our parents
				if (JSUtil.notNil(kc.parent_id)) {
					if (kc.parent_id == cat)
						return true;
					return isSubCat(cat,kc.parent_id);
				}
				return false;
			}
	}
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2018-09-12 00:55:22</sys_created_on>
        <sys_id>1eb99cbcdb2c2300f6de0181ca9619a5</sys_id>
        <sys_mod_count>1</sys_mod_count>
        <sys_name>PRM E-Learning Categories Multi Level</sys_name>
        <sys_package display_value="Partner relationship management" source="x_attme_prm">c7f06ca3dba3170061850a45ca9619b7</sys_package>
        <sys_policy/>
        <sys_scope display_value="Partner relationship management">c7f06ca3dba3170061850a45ca9619b7</sys_scope>
        <sys_update_name>sp_widget_1eb99cbcdb2c2300f6de0181ca9619a5</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2018-09-12 00:55:36</sys_updated_on>
        <template><![CDATA[<script type="text/ng-template" id="nestedCategories">
   <div ng-repeat-start="cat in data.categories[cat.sys_id]" class="list-group-item">
      <a class="category" ng-class="{'active':cat.open}" style="display:block;"><span><div style="display:inline" ng-click="c.catSelect(cat.sys_id)">{{cat.title}}</div><div ng-click="cat.open=!cat.open" class="pull-right glyphicon" ng-class="{'glyphicon-chevron-down': cat.open, 'glyphicon-chevron-right': !cat.open}" ng-if="c.hasChildren(cat)" ></div></span></a>
      <div ng-if="data.showHelp" style="font-size:10px">{{cat.tooltip}}</div>
    </div>
		<div ng-if="c.hasChildren(cat) && cat.open" ng-repeat-end ng-include="'nestedCategories'" class="darken list-group"></div>
</script>

<div class="panel panel-primary b">  
	<div class="panel-heading">
		${KB Categories}<a class="panel-title"></a>
	</div>
  
  <div class="list-group">  
    <div ng-repeat-start="cat in data.categories['top']" class="list-group-item">  
      <a class="category" ng-class="{'active':cat.open}" style="display:block;"><span><div style="display:inline;margin-left:5px;" ng-click="c.catSelect(cat.sys_id)">{{cat.title}}</div><div ng-click="cat.open=!cat.open" class="pull-right glyphicon" ng-class="{'glyphicon-chevron-down': cat.open, 'glyphicon-chevron-right': !cat.open}" ng-if="c.hasChildren(cat)" ></div></span></a>
      <div ng-if="data.showHelp" style="font-size:10px">{{cat.tooltip}}</div>
    </div>
		<div ng-if="c.hasChildren(cat) && cat.open" ng-repeat-end ng-include="'nestedCategories'" class="darken list-group"></div>
	</div>
</div>
]]></template>
    </sp_widget>
</record_update>
